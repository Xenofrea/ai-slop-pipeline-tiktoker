# ÐœÐµÑ…Ð°Ð½Ð¸Ð·Ð¼ Retry ðŸ”„

## ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð°

ÐŸÑ€Ð¸ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ 10+ Ð²Ð¸Ð´ÐµÐ¾ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾, Ð¸Ð½Ð¾Ð³Ð´Ð° API Ð¼Ð¾Ð¶ÐµÑ‚ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÑƒ:
- Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ ÑÐ±Ð¾Ð¸ ÑÐµÑ‚Ð¸
- Rate limiting
- Timeout Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹
- ÐžÑˆÐ¸Ð±ÐºÐ¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð½Ð° ÑÑ‚Ð¾Ñ€Ð¾Ð½Ðµ FAL.AI

**Ð‘ÐµÐ· retry:** ÐžÐ´Ð½Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð»Ð¾Ð¼Ð°ÐµÑ‚ Ð²ÐµÑÑŒ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½, Ð¸ Ð½ÑƒÐ¶Ð½Ð¾ Ð½Ð°Ñ‡Ð¸Ð½Ð°Ñ‚ÑŒ Ð·Ð°Ð½Ð¾Ð²Ð¾.

**Ð¡ retry:** ÐšÐ°Ð¶Ð´Ð¾Ðµ Ð²Ð¸Ð´ÐµÐ¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ‹Ñ‚Ð°ÐµÑ‚ÑÑ Ð¿ÐµÑ€ÐµÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒÑÑ Ð´Ð¾ 3 Ñ€Ð°Ð·.

## ÐšÐ°Ðº ÑÑ‚Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚

### RetryHelper

Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ð° `src/utils/retry-helper.ts` Ñ€ÐµÐ°Ð»Ð¸Ð·ÑƒÐµÑ‚ retry Ð»Ð¾Ð³Ð¸ÐºÑƒ Ñ exponential backoff:

```typescript
await RetryHelper.retry(
  async () => {
    // Ð’Ð°Ñˆ ÐºÐ¾Ð´, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¼Ð¾Ð¶ÐµÑ‚ ÑƒÐ¿Ð°ÑÑ‚ÑŒ
    return await someApiCall();
  },
  {
    maxAttempts: 3,        // ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº
    delayMs: 3000,         // ÐÐ°Ñ‡Ð°Ð»ÑŒÐ½Ð°Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° (3 ÑÐµÐºÑƒÐ½Ð´Ñ‹)
    backoffMultiplier: 2,  // ÐœÐ½Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸ (Ã—2 ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ€Ð°Ð·)
    onRetry: (attempt, error) => {
      console.log(`ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° ${attempt} Ð½Ðµ ÑƒÐ´Ð°Ð»Ð°ÑÑŒ: ${error.message}`);
    }
  }
);
```

### Exponential Backoff

Ð—Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸ Ð¼ÐµÐ¶Ð´Ñƒ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ°Ð¼Ð¸ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÑŽÑ‚ÑÑ ÑÐºÑÐ¿Ð¾Ð½ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾:
- **ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° 1:** ÐÐµÐ¼ÐµÐ´Ð»ÐµÐ½Ð½Ð¾
- **ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° 2:** Ð§ÐµÑ€ÐµÐ· 3 ÑÐµÐºÑƒÐ½Ð´Ñ‹
- **ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° 3:** Ð§ÐµÑ€ÐµÐ· 6 ÑÐµÐºÑƒÐ½Ð´
- **ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° 4:** Ð§ÐµÑ€ÐµÐ· 12 ÑÐµÐºÑƒÐ½Ð´ (ÐµÑÐ»Ð¸ maxAttempts = 4)

Ð­Ñ‚Ð¾ Ð´Ð°Ñ‘Ñ‚ API Ð²Ñ€ÐµÐ¼Ñ Ð²Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒÑÑ Ð¿Ñ€Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð°Ñ….

## ÐŸÑ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð² Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð²Ð¸Ð´ÐµÐ¾

Ð’ `src/workflows/video-generation-workflow.ts:74-115` ÐºÐ°Ð¶Ð´Ð¾Ðµ Ð²Ð¸Ð´ÐµÐ¾ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ñ retry:

```typescript
const videoPromises = prompts.map(async (prompt, i) => {
  return await RetryHelper.retry(
    async () => {
      // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
      const imageUrl = await this.fluxClient.generateImage(...);

      // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð²Ð¸Ð´ÐµÐ¾
      const result = await this.veo3Client.generateVideo(...);

      return { index: i, url: result.videoUrl };
    },
    {
      maxAttempts: 3,
      delayMs: 3000,
      backoffMultiplier: 2,
      onRetry: (attempt, error) => {
        console.log(`âš ï¸  Ð’Ð¸Ð´ÐµÐ¾ ${i + 1}: Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° ${attempt}/3 Ð½Ðµ ÑƒÐ´Ð°Ð»Ð°ÑÑŒ`);
        console.log(`   ÐžÑˆÐ¸Ð±ÐºÐ°: ${error.message}`);
        console.log(`   ðŸ”„ ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ð°Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· ${3000 * Math.pow(2, attempt - 1)}Ð¼Ñ...`);
      }
    }
  );
});

await Promise.all(videoPromises);
```

## ÐŸÑ€Ð¸Ð¼ÐµÑ€ Ð»Ð¾Ð³Ð° Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ

```
ðŸŽ¬ Ð—Ð°Ð¿ÑƒÑÐº Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð²Ð¸Ð´ÐµÐ¾ 5/10...
ðŸ“ ÐŸÑ€Ð¾Ð¼Ð¿Ñ‚: A futuristic cityscape at night with neon lights...

âŒ API Error: Request timeout

âš ï¸  Ð’Ð¸Ð´ÐµÐ¾ 5: Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° 1/3 Ð½Ðµ ÑƒÐ´Ð°Ð»Ð°ÑÑŒ
   ÐžÑˆÐ¸Ð±ÐºÐ°: Request timeout
   ðŸ”„ ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ð°Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° Ñ‡ÐµÑ€ÐµÐ· 3000Ð¼Ñ...

ðŸŽ¬ ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ð°Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð²Ð¸Ð´ÐµÐ¾ 5...
âœ… Ð’Ð¸Ð´ÐµÐ¾ 5 Ð³Ð¾Ñ‚Ð¾Ð²Ð¾: https://fal.ai/files/video_5.mp4 (5/10)
```

## ÐšÐ¾Ð³Ð´Ð° retry Ð½Ðµ Ð¿Ð¾Ð¼Ð¾Ð³Ð°ÐµÑ‚

Ð•ÑÐ»Ð¸ Ð²ÑÐµ 3 Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð½Ðµ ÑƒÐ´Ð°Ð»Ð¸ÑÑŒ, Ð²Ð¸Ð´ÐµÐ¾ Ð²ÑÑ‘ Ñ€Ð°Ð²Ð½Ð¾ ÑƒÐ¿Ð°Ð´Ñ‘Ñ‚ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹:

```
âš ï¸  Ð’Ð¸Ð´ÐµÐ¾ 5: Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° 1/3 Ð½Ðµ ÑƒÐ´Ð°Ð»Ð°ÑÑŒ
âš ï¸  Ð’Ð¸Ð´ÐµÐ¾ 5: Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° 2/3 Ð½Ðµ ÑƒÐ´Ð°Ð»Ð°ÑÑŒ
âš ï¸  Ð’Ð¸Ð´ÐµÐ¾ 5: Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° 3/3 Ð½Ðµ ÑƒÐ´Ð°Ð»Ð°ÑÑŒ
âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ð²Ð¸Ð´ÐµÐ¾ 5: All retry attempts failed
```

Ð’ ÑÑ‚Ð¾Ð¼ ÑÐ»ÑƒÑ‡Ð°Ðµ Ð¼Ð¾Ð¶Ð½Ð¾:
1. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ API ÐºÐ»ÑŽÑ‡Ð¸
2. ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÐºÐ²Ð¾Ñ‚Ñƒ API
3. Ð£Ð¼ÐµÐ½ÑŒÑˆÐ¸Ñ‚ÑŒ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð°Ñ€Ð°Ð»Ð»ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
4. Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ñ‚ÑŒ `maxAttempts` Ð² ÐºÐ¾Ð´Ðµ

## ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°

ÐœÐ¾Ð¶Ð½Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ retry Ð² `video-generation-workflow.ts:105-114`:

```typescript
{
  maxAttempts: 5,        // Ð‘Ð¾Ð»ÑŒÑˆÐµ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº
  delayMs: 5000,         // Ð”Ð¾Ð»ÑŒÑˆÐµ Ð¶Ð´Ñ‘Ð¼
  backoffMultiplier: 1.5, // ÐœÐµÐ´Ð»ÐµÐ½Ð½ÐµÐµ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ
  // ...
}
```

## ÐŸÑ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²Ð°

âœ… **Ð¡Ñ‚Ð°Ð±Ð¸Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ:** Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð½Ðµ Ð»Ð¾Ð¼Ð°ÑŽÑ‚ Ð²ÐµÑÑŒ Ð¿Ð°Ð¹Ð¿Ð»Ð°Ð¹Ð½
âœ… **ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ñ:** ÐÐµ Ð½ÑƒÐ¶Ð½Ð¾ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ
âœ… **ÐŸÑ€Ð¾Ð·Ñ€Ð°Ñ‡Ð½Ð¾ÑÑ‚ÑŒ:** Ð’ÑÐµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð»Ð¾Ð³Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ
âœ… **Ð“Ð¸Ð±ÐºÐ¾ÑÑ‚ÑŒ:** Ð›ÐµÐ³ÐºÐ¾ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´ ÑÐ²Ð¾Ð¸ Ð½ÑƒÐ¶Ð´Ñ‹

## Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð² Ð´Ñ€ÑƒÐ³Ð¸Ñ… Ð¼ÐµÑÑ‚Ð°Ñ…

RetryHelper Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ð»Ñ Ð»ÑŽÐ±Ñ‹Ñ… Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹:

```typescript
// Retry Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ Ñ‚ÐµÐºÑÑ‚Ð°
const text = await RetryHelper.retry(
  () => this.textGenerator.generateStory(description),
  { maxAttempts: 3 }
);

// Retry Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ Ð²Ð¸Ð´ÐµÐ¾
const path = await RetryHelper.retry(
  () => this.videoDownloader.download(url, path),
  { maxAttempts: 5, delayMs: 5000 }
);
```
